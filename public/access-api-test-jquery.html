<!DOCTYPE html>
<html lang="en">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        var counter = 0;
        var max = 50;
        var maxCycles = 5;
        var thisCycle = 0;
        var reqheader = 'BQAe3GD_4sS2LrHAf-O9JW8LrFh86hWkJCrR7bFwW8J8CaLqzVK2GindEBJQHk5b74U5s2dQqvGByzXwgYDr6lhJ_uncZMPbfyiFyZNdsVE3U94J7aNLLpfrIoUn6alSMrme_PSpbtBuCzD6mlNj0T-bSuA50TNwSNHRS4t5VeSeCKop-JAg9u2tQAS2GA';
        var special_value;
        var intervalId;

        $(document).ready(requestSongs(50, thisCycle));

        function requestSongs(_max, _thisCycle) {
            window.setInterval(checkIfReady, 1000);
            $.ajax({
                url: 'https://api.spotify.com/v1/me/tracks?limit=' + _max + '&offset=' + _max * _thisCycle,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + reqheader
                },
                success: function(resultA) {
                    special_value = resultA;
                    var top100artists = [];

                    for (var i = 0; i < _max; i++) {
                        try {
                            top100artists.push(resultA.items[i].track.artists[0].id);
                        } catch {}
                    }

                    for (var i = 0; i < top100artists.length; i++) {
                        function getAjax() {
                            return $.ajax({
                                    url: 'https://api.spotify.com/v1/artists/' + top100artists[i],
                                    type: 'GET',
                                    headers: {
                                        'Authorization': 'Bearer ' + reqheader
                                    },
                                    success: function(resultB) { }
                            })
                        }
                        getAjax().done(function(response) {
                            counter++;
                            $('#test-p-1').after('<p>' + response.genres + '</p>');
                        });
                        getAjax().fail(function(error) {
                            $('#test-p-1').after('<p>null</p>');
                        });
                    }
                }
            });
        };

        function checkIfReady() {
            var testdiv1 = document.getElementById('test-div-1');
            var testp2 = document.getElementById('test-p-2');

            if (testdiv1.children.length >= max * thisCycle + 1) {
                clearInterval(intervalId);
                
                thisCycle++;
                if (thisCycle < maxCycles) {
                    requestSongs(max, thisCycle);
                } else {
                    doMLStuff();
                }
            }
        }

        function doMLStuff() {
            alert(counter);
            var testdiv1 = document.getElementById('test-div-1');
            var testp2 = document.getElementById('test-p-2');

            var genreCounts = new Object();
            if (testdiv1.children.length >= max + 1) {
                clearInterval(intervalId);

                var testDiv1Children = testdiv1.children;
                for (var i = 1; i < testDiv1Children.length; i++) {
                    var str = testDiv1Children[i].innerText;
                    try {
                        var thisDivGenres = str.split(',');
                        for (var j = 0; j < thisDivGenres.length; j++) {
                            if (genreCounts[thisDivGenres[j]] == null) {
                                genreCounts[thisDivGenres[j]] = 1;
                            }
                            else {
                                genreCounts[thisDivGenres[j]]++;
                            }
                        }
                    } catch { }
                }
            }

            var dictString = '';
            var genreCountsKeys = Object.keys(genreCounts);
            function sortByCount(array) {
                return array.sort(function(a, b) {
                    var x = genreCounts[a];
                    var y = genreCounts[b];
                    return ((x > y) ? -1 : ((x < y) ? 1 : 0));
                });
            }
            sortByCount(genreCountsKeys);
            
            for (var i = 0; i < genreCountsKeys.length; i++) {
                dictString += genreCountsKeys[i] + ': ' + genreCounts[genreCountsKeys[i]] + '\n';
            }
            
            //alert(dictString);
            testp2.innerText = dictString;
        }

    </script>
    <body>
        <div id="test-div-1">
            <p id="test-p-1">Genres:</p>
        </div>
        <p id="test-p-2"></p>
    </body>
</html>