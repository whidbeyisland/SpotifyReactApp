<!DOCTYPE html>
<html lang="en">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        //var testdiv1 = document.getElementById('test-div-1');
        var testp1 = document.getElementById('test-p-1');
        var testp2 = document.getElementById('test-p-2');
        
        var max = 50;
        var reqheader = 'BQBFemh7RaPy9Y1-8Y6Ohb1iSqE9-33I2JXxmXTdKEuJWC8RKUIzZ_Ko02mo7aQr41G8Itx2tuVrm9g-AlKOseahRpFINPOq3bf6fRCXWhXSlYEVLNsVfXnLhemNlfmn46uELBoa-Qry8jcRs4_IvYR3_zR4TtkMcAR62QhLUAZ0wDXrmOue-ZSS-4xLXQ';
        var special_value;

        $(document).ready(docReadyFunc);

        function docReadyFunc() {
            $.ajax({
                url: 'https://api.spotify.com/v1/me/tracks?limit=' + max,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + reqheader
                },
                success: function(resultA) {
                    special_value = resultA;
                    var top100artists = [];

                    for (var i = 0; i < max; i++) {
                        try {
                            top100artists.push(resultA.items[i].track.artists[0].id);
                        } catch {}
                    }

                    for (var i = 0; i < top100artists.length; i++) {
                        function getAjax() {
                            return $.ajax({
                                    //https://api.spotify.com/v1/artists/
                                    url: 'https://api.spotify.com/v1/artists/' + top100artists[i],
                                    type: 'GET',
                                    headers: {
                                        'Authorization': 'Bearer ' + reqheader
                                    },
                                    success: function(resultB) { }
                            })
                        }
                        getAjax().done(function(response) {
                            $('#test-p-1').after('<p>' + response.genres + '</p>');
                        });
                        getAjax().fail(function(error) {
                            $('#test-p-1').after('<p>null</p>');
                        });
                    }
                }
            });

            var intervalId = window.setInterval(doMLStuff, 1000);

            function doMLStuff() {
                var testdiv1 = document.getElementById('test-div-1');
                var testp2 = document.getElementById('test-p-2');

                var genreCounts = new Object();
                if (testdiv1.children.length >= max + 1) {
                    clearInterval(intervalId);

                    var testDiv1Children = testdiv1.children;
                    for (var i = 1; i < testDiv1Children.length; i++) {
                        var str = testDiv1Children[i].innerText;
                        try {
                            var thisDivGenres = str.split(',');
                            for (var j = 0; j < thisDivGenres.length; j++) {
                                if (genreCounts[thisDivGenres[j]] == null) {
                                    genreCounts[thisDivGenres[j]] = 1;
                                }
                                else {
                                    genreCounts[thisDivGenres[j]]++;
                                }
                            }
                        } catch { }
                    }
                }

                var dictString = '';
                var genreCountsKeys = Object.keys(genreCounts);
                function sortByCount(array) {
                    return array.sort(function(a, b) {
                        var x = genreCounts[a];
                        var y = genreCounts[b];
                        return ((x > y) ? -1 : ((x < y) ? 1 : 0));
                    });
                }
                sortByCount(genreCountsKeys);
                
                for (var i = 0; i < genreCountsKeys.length; i++) {
                    dictString += genreCountsKeys[i] + ': ' + genreCounts[genreCountsKeys[i]] + '\n';
                }
                
                //alert(dictString);
                testp2.innerText = dictString;
            }

        };

    </script>
    <body>
        <div id="test-div-1">
            <p id="test-p-1">Genres:</p>
        </div>
        <p id="test-p-2"></p>
    </body>
</html>